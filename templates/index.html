<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeuroSense</title>

    <!-- Load jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

    <script src="https://cdn.jsdelivr.net/npm/particles.js"></script>

</head>

<body>

    <div id="particles-js"></div> <!-- Particle Animation -->
    <div class="logo-container">
        <img src="{{ url_for('static', filename='images/NEuroSense.png') }}" alt="Logo" class="logo">
    </div>

    <div class="main-container">
        <!-- Single Video Upload Section -->
        <div class="section">
            <h2>Single Video Upload</h2>
            <input type="file" id="singleVideoUpload" accept="video/*" required>

            <!-- Dropdowns for selection -->
            <div class="dropdown-container">
                <select class="dropdown" id="muscleGroup" required>

                    <option value="">Select Muscle Group</option>
                    <option value="BB">Bicep Brachii</option>
                    <option value="MG">Medial Gastronemius</option>
                    <option value="TRAP">Trapezius</option>
                    <option value="TP">Thoracic Paraspinal</option>
                    <option value="ADM">Abductor Digiti Minimi</option>

                </select>

                <select class="dropdown" id="probeOrientation" required onchange="previewSingleVideo()">
                    <option value="">Select Probe Orientation</option>
                    <option value="longitudinal">Longitudinal</option>
                    <option value="transverse">Transverse</option>
                </select>
            </div>

            <button class="button" onclick="previewSingleVideos()">Upload Single Video</button>

            <script>

                // Function to preview the uploaded video
                function previewSingleVideo() {
                    var file = document.getElementById("singleVideoUpload").files[0];
                    if (file) {
                        var videoPlayer = document.getElementById("singleVideoPlayer");
                        var objectURL = URL.createObjectURL(file);
                        videoPlayer.src = objectURL;
                        videoPlayer.style.display = "block";  // Show the video player
                        videoPlayer.load();  // Required after changing sources dynamically

                    }
                }

                function previewSingleVideos() {
                    const fileInput = document.getElementById('singleVideoUpload');
                    const muscleGroup = document.getElementById('muscleGroup').value;
                    const probeOrientation = document.getElementById('probeOrientation').value;
                    const file = fileInput.files[0];

                    if (!file) {
                        alert("Please select a video file first.");
                        return;
                    }

                    const progressContainer = document.getElementById("progressBarContainer");
                    const progressValue = progressContainer.querySelector(".progress-value");

                    // Show the entire progress + message
                    progressContainer.classList.remove("hidden");
                    progressValue.style.animation = "none";
                    void progressValue.offsetWidth; // force reflow
                    progressValue.style.animation = "load 7s linear infinite";

                    // Start upload
                    const formData = new FormData();
                    formData.append("video", file);
                    formData.append("muscle_group", muscleGroup);
                    formData.append("probe_orientation", probeOrientation);

                    fetch("/upload", {
                        method: "POST",
                        body: formData
                    })
                        .then(response => {
                            if (response.redirected) {
                                window.location.href = response.url;
                            } else {
                                return response.text().then(text => { throw new Error(text); });
                            }
                        })
                        .catch(error => {
                            progressBar.classList.add('hidden'); // hide on error
                            console.error("Error:", error);
                            alert("Error uploading or processing video: " + error.message);
                        });
                }

            </script>

            <!-- Video display window -->
            <div id="singleVideoPreview" style="margin-top: 15px;">
                <video id="singleVideoPlayer" controls preload="metadata" width="640" height="360"
                    style="display: none;">
                    Your browser does not support HTML5 video.
                </video>
            </div>

            <div id="progressBarContainer" class="hidden">
                <div class="progress">
                    <div class="progress-value"></div>
                </div>
                <div class="wait-message">Please wait...</div>
            </div>
        </div>

        <!-- Bulk Video Upload Section -->
        <div class="section">
            <h2>Bulk Video Upload</h2>

            <!-- Select Folder Button -->
            <button class="button" onclick="selectFolder()">Select Folder</button>

            <a id="downloadExcelLink" style="display:none;" download="files_list.xlsx">
                <button class="download-button">Download Excel</button>
            </a>
            <p id="fillReminder" style="display:none; color: red; margin-top: 10px;">
                Before submitting the Excel file for bulk processing, please complete the muscle group and probe
                orientation.
            </p>

            <!-- Excel Upload Input -->
            <input type="file" id="bulkExcelUpload" accept=".xlsx, .csv" style="margin-top: 10px;">
            <button class="button" onclick="uploadExcel()">Upload Excel File</button>

            <!-- Progress bar + wait message (initially hidden) -->
            <div id="progressBarContainer_bulk" class="hidden">
                <div class="progress">
                    <div class="progress-value"></div>
                </div>
                <div class="wait-message">Please wait...</div>
            </div>
        </div>

    </div>

    <!-- Footer -->
    <footer>
        Designed and Developed by Dheeraj Pandey
    </footer>


    <script>
        $(document).ready(function () {
            console.log("jQuery Loaded!");
        });


        function uploadExcel() {
            var file = document.getElementById("bulkExcelUpload").files[0];
            if (file) {
                alert("Excel file uploaded: " + file.name);
            }
        }

        
        function selectFolder() {
            fetch('/select-folder', { method: 'POST' })  // Send request to backend
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        let downloadLink = document.getElementById('downloadExcelLink');
                        downloadLink.href = data.file_url;
                        downloadLink.style.display = 'block';  // Show download button
                        document.getElementById("fillReminder").style.display = "block";
                    } else {
                        alert("Failed to generate Excel.");
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        function uploadExcel() {
            const fileInput = document.getElementById("bulkExcelUpload");
            const file = fileInput.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append("file", file);

             // Show progress bar and reset animation
            const progressContainer = document.getElementById("progressBarContainer_bulk");
            const progressValue = progressContainer.querySelector(".progress-value");

            progressContainer.classList.remove("hidden");
            progressValue.style.animation = "none";
            void progressValue.offsetWidth; // force reflow
            progressValue.style.animation = "load 3s linear infinite";

            const xhr = new XMLHttpRequest();

            xhr.onload = function () {
            if (xhr.status === 200) {
                alert("Upload complete!");
                setTimeout(function () {
                    window.location.href = "/results";  // Redirect to the results page
                }, 300); 
            } else {
                alert("Upload failed.");
            }
        };

            xhr.onerror = function () {
                alert("An error occurred during upload.");
            };

            xhr.open("POST", "/upload-excel", true);
            xhr.send(formData);
        }
    </script>
    <script src="{{ url_for('static', filename='js/config.js') }}"></script>

</body>

</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeuroSense</title>

    <!-- Load jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/particles.js"></script>
</head>
<body>

    <div id="particles-js"></div> <!-- Particle Animation -->
    <div class="logo-container">
        <img src="{{ url_for('static', filename='images/NEuroSense.png') }}" alt="Logo" class="logo">
    </div>

    <div class="main-container">
        <!-- Single Video Upload Section -->
        <div class="section">
            <h2>Single Video Upload</h2>
            <input type="file" id="singleVideoUpload" accept="video/*" onchange="previewSingleVideo()">

             <!-- Dropdowns for selection -->
             <div class="dropdown-container">
                <select class="dropdown" id="muscleGroup" required>
                    
                    <option value="">Select Muscle Group</option>
                    <option value="default">Default</option>
                    <option value="BB">Bicep Brachii</option>
                    <option value="MG">Medial Gastronemius</option>
                    <option value="TRAP">Trapezius</option>
                    <option value="TP">Thoracic Paraspinal</option>
                    <option value="ADM">Abductor Digiti Minimi</option>
                </select>

                <select class="dropdown" id="probeOrientation" required>
                    <option value="">Select Probe Orientation</option>
                    <option value="longitudinal">Longitudinal</option>
                    <option value="transverse">Transverse</option>
                </select>
            </div>

            <button class="button" onclick="previewSingleVideos()">Upload Single Video</button>
            
            <script>
            function previewSingleVideos() {
                const fileInput = document.getElementById('singleVideoUpload'); 
                const muscleGroup = document.getElementById('muscleGroup').value;
                const probeOrientation = document.getElementById('probeOrientation').value;
                const file = fileInput.files[0];
            
                if (!file) {
                    alert("Please select a video file first.");
                    return;
                }
            
                const formData = new FormData();
                formData.append("video", file);
                formData.append("muscle_group", muscleGroup);
                formData.append("probe_orientation", probeOrientation);
            
                fetch("/upload", {
                    method: "POST",
                    body: formData
                })
                .then(response => {
                    if (response.redirected) {
                        window.location.href = response.url;  // Redirect to /result
                    } else {
                        return response.text().then(text => { throw new Error(text); });
                    }
                })
                .catch(error => {
                    console.error("Error:", error);
                    alert("Error uploading or processing video: " + error.message);
                });
            }
            </script>
            
            <!-- Video display window -->
            <div id="singleVideoPreview">
                <video id="singleVideoPlayer" controls style="display: none;">
                    Your browser does not support the video tag.
                </video>
            </div>
        </div>

        <!-- Bulk Video Upload Section -->
        <div class="section">
            <h2>Bulk Video Upload</h2>

            <!-- Select Folder Button -->
            <button class="button" onclick="selectFolder()">Select Folder</button>
            
            <!-- Excel Upload Input -->
            <input type="file" id="bulkExcelUpload" accept=".xlsx, .csv">
            <button class="button" onclick="uploadExcel()">Upload Excel File</button>

            <!-- Add a progress bar and estimated time text -->
            <progress id="uploadProgress" value="0" max="100" style="width: 100%; display:none;"></progress>
            <p id="estimatedTime" style="display:none;">Estimated time: <span id="timeLeft">Calculating...</span></p>

            <!-- Excel Download Button -->
            <a id="downloadExcelLink" style="display:none;" download="files_list.xlsx">
                <button class="download-button">Download Excel</button>
            </a>
        </div>
        
    </div>

    <!-- Footer -->
    <footer>
        Designed and Developed by Dheeraj Pandey
    </footer>


    <script>
        $(document).ready(function() {
            console.log("jQuery Loaded!");
        });

        // Function to preview the uploaded video
        function previewSingleVideo() {
            var file = document.getElementById("singleVideoUpload").files[0];
            if (file) {
                var videoPlayer = document.getElementById("singleVideoPlayer");
                var objectURL = URL.createObjectURL(file);
                videoPlayer.src = objectURL;
                videoPlayer.style.display = "block";  // Show the video player
            }
        }

        function uploadExcel() {
            var file = document.getElementById("bulkExcelUpload").files[0];
            if (file) {
                alert("Excel file uploaded: " + file.name);
            }
        }

        // Initialize Particle Animation (Green Particles on White Background)
        particlesJS("particles-js", {
            particles: {
                number: { value: 80, density: { enable: true, value_area: 800 } },
                color: { value: "#00c0b5" }, /* Green particles */
                shape: { type: "circle" },
                opacity: { value: 0.7, random: false },
                size: { value: 3, random: true },
                line_linked: { enable: true, distance: 150, color: "#00c0b5", opacity: 0.6, width: 1 },
                move: { enable: true, speed: 2, direction: "none", random: false, straight: false }
            },
            interactivity: {
                detect_on: "canvas",
                events: {
                    onhover: { enable: true, mode: "repulse" },
                    onclick: { enable: true, mode: "push" }
                },
                modes: {
                    repulse: { distance: 100, duration: 0.4 },
                    push: { particles_nb: 4 }
                }
            }
        });

        function selectFolder() {
        fetch('/select-folder', { method: 'POST' })  // Send request to backend
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                let downloadLink = document.getElementById('downloadExcelLink');
                downloadLink.href = data.file_url;
                downloadLink.style.display = 'block';  // Show download button
            } else {
                alert("Failed to generate Excel.");
            }
        })
        .catch(error => console.error('Error:', error));
}

function uploadExcel() {
    const fileInput = document.getElementById("bulkExcelUpload");
    const file = fileInput.files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append("file", file);

    const xhr = new XMLHttpRequest();

    const progressBar = document.getElementById("uploadProgress");
    const timeText = document.getElementById("estimatedTime");
    const timeLeftSpan = document.getElementById("timeLeft");

    progressBar.style.display = "block";
    timeText.style.display = "block";

    let startTime = Date.now();

    xhr.upload.addEventListener("progress", function (event) {
        if (event.lengthComputable) {
            let percentComplete = (event.loaded / event.total) * 100;
            progressBar.value = percentComplete;

            let elapsedTime = (Date.now() - startTime) / 1000; // seconds
            let estimatedTotalTime = (elapsedTime / percentComplete) * 100;
            let timeRemaining = estimatedTotalTime - elapsedTime;

            if (percentComplete < 100) {
                timeLeftSpan.innerText = `${timeRemaining.toFixed(1)} seconds`;
            } else {
                timeLeftSpan.innerText = "Processing...";
            }
        }
    });

    xhr.onload = function () {
        if (xhr.status === 200) {
            alert("Upload complete!");
            progressBar.style.display = "none";
            timeText.style.display = "none";
            window.location.href = "/results";  // Redirect to the results page
        } else {
            alert("Upload failed.");
        }
    };

    xhr.onerror = function () {
        alert("An error occurred during upload.");
    };

    xhr.open("POST", "/upload-excel", true);
    xhr.send(formData);
}
        </script>
    </body>
</html>